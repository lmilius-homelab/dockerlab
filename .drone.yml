---
kind: pipeline
name: whoami
type: docker

trigger:
  branch:
  - master
  event:
  - push

steps:
- name: Deploy
  image: docker/compose
  commands:
  - cd whoami
  - docker-compose up -d
  volumes:
  - name: dockersock
    path: /var/run/docker.sock
  when:
    event:
    - push

volumes:
- name: dockersock
  host:
    path: /var/run/docker.sock


---
kind: pipeline
name: portainer
type: docker

trigger:
  branch:
  - master
  event:
  - push

steps:
- name: Deploy
  image: docker/compose
  commands:
  - cd portainer
  - docker-compose up -d
  volumes:
  - name: dockersock
    path: /var/run/docker.sock
  when:
    event:
    - push

volumes:
- name: dockersock
  host:
    path: /var/run/docker.sock


---
kind: pipeline
name: watchtower
type: docker

trigger:
  branch:
  - master
  event:
  - push

steps:
- name: Deploy
  image: docker/compose
  commands:
  - cd watchtower
  - docker-compose up -d
  volumes:
  - name: dockersock
    path: /var/run/docker.sock
  when:
    event:
    - push

volumes:
- name: dockersock
  host:
    path: /var/run/docker.sock



---
kind: pipeline
name: volumerize
type: docker

trigger:
  branch:
  - master
  event:
  - push

steps:
- name: Deploy
  image: docker/compose
  commands:
  - cd volumerize
  - docker-compose up -d
  volumes:
  - name: dockersock
    path: /var/run/docker.sock
  when:
    event:
    - push

volumes:
- name: dockersock
  host:
    path: /var/run/docker.sock


#---
#kind: pipeline
#name: dashboard
#type: docker
#
#trigger:
#  branch:
#  - master
#  event:
#  - push
#
#steps:
#- name: Deploy
#  image: docker/compose
#  commands:
#  - cd dashboard
#  #- docker-compose up -d
#  - docker-compose down
#  volumes:
#  - name: dockersock
#    path: /var/run/docker.sock
#  when:
#    event:
#    - push
#  environment:
#    GF_SECURITY_ADMIN_PASSWORD:
#      from_secret: admin_password
#
#volumes:
#- name: dockersock
#  host:
#    path: /var/run/docker.sock
#

---
kind: pipeline
type: docker
name: dashboard

depends_on:
- portainer

steps:
- name: deploy
  image: lmilius/drone-portainer-deploy
  settings:
    url: https://portainer-int.lukemilius.com
    username:
      from_secret: portainer_username
    password:
      from_secret: portainer_password
    endpoint: local
    type: stack
    stack_name: dashboard
    stack_file: dashboard/docker-compose.yml


---
kind: pipeline
name: organizr
type: docker

trigger:
  branch:
  - master
  event:
  - push

steps:
- name: Deploy
  image: docker/compose
  commands:
  - cd organizr
  - docker-compose up -d
  volumes:
  - name: dockersock
    path: /var/run/docker.sock
  when:
    event:
    - push

volumes:
- name: dockersock
  host:
    path: /var/run/docker.sock


---
kind: pipeline
name: ddns
type: docker

trigger:
  branch:
  - master
  event:
  - push

steps:
- name: Deploy
  image: docker/compose
  commands:
  - cd ddns
  - docker-compose up -d
  volumes:
  - name: dockersock
    path: /var/run/docker.sock
  when:
    event:
    - push
  environment:
    API_KEY:
      from_secret: ddns_token

volumes:
- name: dockersock
  host:
    path: /var/run/docker.sock


#---
#kind: pipeline
#name: rancher
#type: docker
#
#trigger:
#  branch:
#  - master
#  event:
#  - push
#
#steps:
#- name: Deploy
#  image: docker/compose
#  commands:
#  - cd rancher
#  - docker-compose up -d
#  volumes:
#  - name: dockersock
#    path: /var/run/docker.sock
#  when:
#    event:
#    - push
#
#volumes:
#- name: dockersock
#  host:
#    path: /var/run/docker.sock


---
kind: pipeline
name: registry
type: docker

trigger:
  branch:
  - master
  event:
  - push

steps:
- name: Deploy
  image: docker/compose
  commands:
  - cd registry
  - docker-compose up -d
  volumes:
  - name: dockersock
    path: /var/run/docker.sock
  when:
    event:
    - push

volumes:
- name: dockersock
  host:
    path: /var/run/docker.sock


---
kind: pipeline
name: homeassistant
type: docker

trigger:
  branch:
  - master
  event:
  - push

steps:
- name: Deploy
  image: docker/compose
  commands:
  - cd homeassistant
  - docker-compose up -d
  volumes:
  - name: dockersock
    path: /var/run/docker.sock
  when:
    event:
    - push
  environment:
    MYSQL_ROOT_PASSWORD:
      from_secret: mysql_root_password
    HA_USER_PASSWORD:
      from_secret: ha_user_password

volumes:
- name: dockersock
  host:
    path: /var/run/docker.sock


---
kind: pipeline
name: bitwarden
type: docker

trigger:
  branch:
  - master
  event:
  - push

steps:
- name: Deploy
  image: docker/compose
  commands:
  - cd bitwarden
  - docker-compose up -d
  volumes:
  - name: dockersock
    path: /var/run/docker.sock
  environment:
    BITWARDEN_ADMIN:
      from_secret: bitwarden_admin_token
  when:
    event:
    - push

volumes:
- name: dockersock
  host:
    path: /var/run/docker.sock


